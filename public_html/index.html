<html>
<head>
  <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.1/css/all.css" integrity="sha384-gfdkjb5BdAXd+lj+gudLWI+BXq4IuLW5IT+brZEZsLFm++aCMlF1V92rMkPaX4PP" crossorigin="anonymous">
  <style>
  .container-fluid{
    padding-right: 30px;
    padding-left: 30px;
  }
  .active-element{
    position: absolute ;
    left: auto;
    right: 0;
    width: calc( 25% - 15px );
    margin-right: 15px;
  }
  .active-element .card{
    z-index: 1000;
  }
  iframe{
    transform: scale(0.75);
    transform-origin: top left;
  }
  .active-tag{
      background-color:  #fa6863;
  }
  .active-tag {
      background-color:  #fa6863;
  }
  </style>
</head>
<body>
    <main id="app" class="container-fluid">
        <div class="row">
            <div class="col-12">
                <h1 class="h6">{{title}}</h1>
                <div class="input-group mb-3">
                    <input type="text" class="form-control" placeholder="URL" v-model="url">
                    <div class="input-group-append">
                        <button class="btn btn-primary" @click="getTargetSite()">取得</button>
                    </div>
                </div>
            </div>
            <div class="col-12">
                <div class="active-element h-75">
                    <div class="card">
                        <div class="card-header py-1">
                            選択中の要素
                        </div>
                        <div class="card-body p-1">
                            <div class="card-title">{{iframeSource}}</div>
                            <ul>
                                <li>TAG: {{activeElement.tag}}</li>
                                <li>ID: {{activeElement.id}}</li>
                                <li>CLASS: {{activeElement.className}}</li>
                                <li>NAME: {{activeElement.name}}</li>
                                <li>INDEX: {{activeElement.index}}</li>
                            </ul>
                            <div class="d-flex">
                                <button class="btn btn-sm btn-primary w-100 mr-1" @click="registerTarget">登録</button>
                                <button class="btn btn-sm border-primary bg-white w-100 mr-1" @click="selectParentNode">親ノード選択</button>
                            </div>
                        </div>
                    </div>
                    <div class="card mt-2">
                        <div class="card-header py-1">
                            登録リスト
                        </div>
                        <div class="card-body p-1" style="min-height:8em;">
                            <ul class="p-1">
                                <li class  = "badge badge-primary mr-1 mb-1" 
                                    v-for  = "(v,i) in registeredList"
                                    @click = "activateRegisteredContents(i,v,$event) "
                                    >
                                        <i class="fas fa-tag mr-1"></i>{{i}}:{{v.nodeName}}
                                        <i class="fas fa-trash ml-2" @click="removeTarget(i,v,$event)"></i>
                                        
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="w-100" style="position: absolute;bottom: 0;">
                        <button class="btn btn-primary w-100" @click="popupScenario">シナリオ登録</button>
                    </div>
                </div>
                <iframe class = "w-100 h-100 border border-info rounded" 
                        type  = "text/html"
                        :id   = "iframeId" 
                        :src  = "iframeSource"
                        @load = "iframeLoaded"
                        ></iframe>
            </div>
        </div>
        {{activeElement}}
    </main>        
</body>
<script>
    var app = new Vue( {
        el:"#app",
        data:{
            title: "ウェブページを取得するフォーム" , 
            url: null ,
            apiUrlTrigerCrawl: '/scrape' , 
            iframeSource: null ,
            iframeId: "crawled-result" ,
            iframeRegisteredClass: "iframe-registered" ,
            iframeActiveClass: "iframe-active",
            iframeAddingStyle: null ,
            activeElement: {
                tag: null,
                id: null,
                className: null,
                name: null,
                index: null
            } ,
            registeredList: [],
            activeTagClass: "active-tag"
        } , 
        methods:{
            getTargetSite: function(){
                var reg = new RegExp( "((https?|ftp)(:\/\/[-_.!~*\'()a-zA-Z0-9;\/?:\@&=+\$,%#]+))");
                if( this.url && this.url.match( reg ) ){
                    const targetUrl = this.apiUrlTrigerCrawl + "?url="+this.url ;
                    axios.get( targetUrl )
                         .then( ( res )=>{
                             // handle success
                             console.log( res ) ;
                             if( res.status === 200 ){
                                 this.iframeSource = "/data/tmp/" + res.data.result ;
                             }else{
                                 throw new Exception("error") ;
                             }
                         } )
                         .catch( ( err )=>{
                            // handle error
                            console.log( err ) ;
                         } ) ;
                }
                // data.url に対してクロールを実行する。
                return null ;
            } ,
            iframeLoaded: function(){
                // 読み込んだiframeの内部にclick event listenerを付与
                const iframe = document.getElementById( this.iframeId ) ;
                if( iframe.src ) {
                    // クリック時にイベントターゲット要素に対しアクティブクラスを追加するイベントリスナーを追加
                    iframe.contentDocument
                          .body
                          .addEventListener( 'click' , this.activateClickedContents , true )
                          ;
                    // クリック時にターゲットをアクティブにするスタイルをiframe内に追加
                    iframe.contentDocument
                          .head
                          .appendChild( this.iframeAddingStyle )
                          ;
                } else {
                    console.log("iframe source is empty");
                }
            } ,
            clearActiveClass: function( iframe ){
                // const iframe = iframe || document.getElementById( this.iframeId ) ;
                // クリック時点でアクティブなものを取得
                const elem = iframe.contentDocument
                                   .getElementsByClassName( this.iframeActiveClass )
                                   ;
                for( let i in elem ){
                    if( elem.hasOwnProperty( i ) ){
                        elem[i].classList.remove( this.iframeActiveClass ) ;
                    }
                }
                const tabs = document.getElementsByClassName( this.activeTagClass ) ;
                for( let i in tabs ){
                    if( tabs.hasOwnProperty( i ) ){
                        tabs[i].classList.remove( this.activeTagClass ) ;
                    }
                }
            },
            activateClickedContents : function( event ){
                // iframe内でクリックされたターゲットコンテンツをアクティブ化する。
                const iframe = document.getElementById( this.iframeId ) ;

                // すでにアクティブ化しているクラスを外す
                this.clearActiveClass( iframe ) ;
                
                // 現クリック先をアクティブにする
                event.target.classList.add( this.iframeActiveClass ) ;

                // クリックした際のセレクターを取得する
                this.getSelectorOfClickedElement( event.target , iframe ) ;
                
            } , 
            activateRegisteredContents : function( index , value , event ){
                const iframe = document.getElementById( this.iframeId ) ;

                // すでにアクティブ化しているクラスを外す
                this.clearActiveClass( iframe ) ;
                
                if( typeof value === "object" ){
                    value.classList.add( this.iframeActiveClass ) ;
                    this.getSelectorOfClickedElement( value , iframe ) ;
                }
                const elems = document.getElementsByClassName( this.activeTagClass ) ;
                for( let i in elems ){
                    if( elems.hasOwnProperty( i ) ){
                        elems[i].classList.remove( this.activeTagClass ) ;
                    }
                }
                event.currentTarget.classList.add( this.activeTagClass );

            } , 
            getSelectorOfClickedElement: function( elem , iframe ) {
                const id   = ( typeof elem.id   !== 'undefined') ? elem.id   : "" ;
                const name = ( typeof elem.name !== 'undefined') ? elem.name : "" ;
                const tag  = ( typeof elem.localName !== 'undefined') ? elem.localName : "" ;

                // class要素がある場合は一旦取り出し、ばらす。アクティブ部分は除く。
                const tempClass = elem.className.replace( this.iframeActiveClass , "" ).trim() ;

                let className = "" ;
                let index     = null ;
                let elements  = null ;

                if( tempClass !== "" ) {
                    className = tempClass ;
                    // そのクラスが他に使用されている場合があるので、再度iframe内を読み解いて何番目かを取得する
                    elements = iframe.contentDocument.body.getElementsByClassName( tempClass );
                }else{
                    elements = iframe.contentDocument.body.getElementsByTagName( tag );
                }
                // アクティブなクラスが何番目になるかをループし格納
                for( let i in elements ){
                    if( elements.hasOwnProperty( i ) && elements[i].classList.contains( this.iframeActiveClass ) ){
                        index = i ;
                        break;
                    }
                }
                // 
                let ret = document.createElement( tag ) ;
                ret.setAttribute( 'id'    , id    ) ;
                ret.setAttribute( 'name'  , name  ) ;
                ret.setAttribute( 'class' , className ) ;
                ret.classList.remove( this.iframeActiveClass )
/*                 if( ret.classList.contains( this.iframeRegisteredClass ) ){
                    ret.classList.remove( this.iframeRegisteredClass ) ;
                } */
                this.activeElement = Object.assign({},{
                    tag: tag , 
                    id: id ,
                    name: name ,
                    className : className ,
                    index: index 
                } ) ;
            },
            registerTarget: function(){
                const iframe = document.getElementById( this.iframeId ) ;
                elements = iframe.contentDocument
                                 .body
                                 .getElementsByClassName( this.iframeActiveClass )
                                 ;
                for( let i in this.registeredList ){
                    if( this.registeredList.hasOwnProperty(i) 
                     && this.registeredList[i] === elements[0] ){
                        console.log( this.registeredList[i] , elements[0] )
                        return 0 ;
                        // 同じものがあればなにもせず
                    }
                }
                this.registeredList.push( elements[0] ) ;
                elements[0].dataset.registered = 1 ;
                /* elements[0].classList.add( this.iframeRegisteredClass ) ; */
                console.log( elements ) ;
            } , 
            removeTarget: function( index , value , event ){
                this.registeredList[ index ].classList.remove( this.iframeActiveClass );
                this.registeredList[ index ].dataset.registered = 0 ;
                this.registeredList.splice( index , 1 );
            },
            selectParentNode: function( event ) {
                const iframe = document.getElementById( this.iframeId ) ;
                const target = iframe.contentDocument
                                     .body
                                     .getElementsByClassName( this.iframeActiveClass )
                                     ;
                if( target.length === 1 ){
                    console.log( target[0].parentNode ) ; 
                    const parent = target[0].parentNode ;
                    // すでにアクティブ化しているクラスを外す
                    this.clearActiveClass( iframe ) ;
                    
                    // 現クリック先の親をアクティブにする
                    parent.classList.add( this.iframeActiveClass ) ;

                    // クリックした際のセレクターを取得する
                    this.getSelectorOfClickedElement( parent , iframe ) ;
                    
                }
            } , 
            popupScenario: function(event){
                console.log(event);
            }
        },
        mounted: function(){
            this.iframeAddingStyle = document.createElement("style") ;
            this.iframeAddingStyle.innerHTML 
                = "."+this.iframeActiveClass + "{"
                +   "background-color: #F009 !important;"
                +   "transform: scaleX(0.95) scaleY(0.97) !important;"
            //    +   "margin: .25em !important;"
            //    +   "padding: .25em !important;"
                +   "border: 3px dashed green !important;"
                +   "background-image: none !important;"
                + "}"
           /*      + "."+this.iframeRegisteredClass + "{"
                +   "background-color: #66F9 !important;"
                +   "margin: .05em !important;"
                +   "padding: .05em !important;"
                +   "border: 1px solid green !important;"
                + "}"
                + "."+this.iframeRegisteredClass + "." + this.iframeActiveClass + "{"
                +   "background-color: #6F69 !important;"
                +   "margin: .25em !important;"
                +   "padding: .25em !important;"
                +   "border: 3px dashed red !important;"
                + "}" */
                                                ; 
        } ,
        watch: {
            iframeSource : function(){
                console.log( this.iframeSource ) ;
            }
        }
    } ) ;
</script>
</html>